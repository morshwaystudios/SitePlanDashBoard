<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>GMF Steel Site Plan Dashboard - Login</title>
<style>
  :root {
    --bg: #0b0f14;
    --accent: #67b7ff;
    --accent2: #1abc9c;
    --error: #e74c3c;
    --text: #e8f0f7;
    --muted: #9fb0c3;
    --panel: #10161d;
  }
  *{box-sizing:border-box}
  body {
    margin:0; height:100vh; display:flex; align-items:center; justify-content:center;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(135deg, #0b0f14 40%, #10161d 100%);
    overflow:hidden; color:var(--text);
  }

  .login-container {
    background: rgba(16,22,29,0.96);
    border: 1px solid #253242;
    border-radius: 16px;
    padding: 36px 28px;
    width: 360px;
    text-align: center;
    box-shadow: 0 6px 30px rgba(103,183,255,0.12);
    animation: fadeIn 400ms ease;
    z-index: 2;
  }

  .login-container h1 {
    margin:0 0 8px;
    font-size: 20px;
    color: var(--accent);
    text-shadow:0 0 8px rgba(103,183,255,0.06);
    letter-spacing:0.6px;
  }
  .login-container p { margin:0 0 18px; font-size:13px; color:var(--muted); }

  .input-group { margin-bottom:14px; text-align:left; }
  .input-group label { font-size:12px; margin-bottom:6px; display:block; color:var(--muted); }
  .input-group input {
    width:100%; padding:10px 12px; border-radius:8px; border:1px solid #233241;
    background:#071018; color:var(--text); font-size:14px;
    transition:border 0.18s, box-shadow 0.18s;
  }
  .input-group input:focus { border-color:var(--accent); outline:none; box-shadow:0 0 10px rgba(103,183,255,0.06); }

  .btn {
    width:100%; padding:12px; border-radius:8px; border:1px solid #2a394a;
    background:var(--accent); color:#06101a; font-weight:700; cursor:pointer; transition:all 0.18s;
  }
  .btn:hover { background:var(--accent2); box-shadow:0 6px 18px rgba(26,188,156,0.08); transform:translateY(-1px); }

  .error { color:var(--error); font-size:13px; margin-top:10px; display:none; }
  .lockout { color:var(--error); font-size:13px; margin-top:10px; display:none; }

  /* Added survey link */
  .survey-link {
    margin-top:12px;
    display:block;
    text-align:center;
    font-size:14px;
  }
  .survey-link a {
    color:var(--accent);
    text-decoration:none;
    transition:color 0.2s;
  }
  .survey-link a:hover { color:var(--accent2); }

  @keyframes fadeIn { from {opacity:0; transform:scale(0.985);} to{opacity:1; transform:scale(1);} }

  .splash {
    position:fixed; top:0; left:0; right:0; bottom:0;
    background:linear-gradient(180deg,#071018 0%, #061018 100%);
    display:flex; align-items:center; justify-content:center;
    flex-direction:column; z-index:999;
    color:var(--text); opacity:0; pointer-events:none;
    transition:opacity 260ms ease;
  }
  .splash.show { opacity:1; pointer-events:auto; }
  .splash h1 {
    font-size:22px; color:#67b7ff; margin:0 0 8px;
    text-shadow:0 0 18px rgba(103,183,255,0.08);
  }
  .splash p { color:var(--muted); margin:0; font-size:13px; }
</style>
</head>
<body>
  <div class="login-container" role="main" aria-labelledby="site-title">
    <h1 id="site-title">GMF STEEL</h1>
    <p>Site Plan Dashboard Login — lab build</p>
    <form id="loginForm" autocomplete="off" novalidate>
      <div class="input-group">
        <label for="username">User</label>
        <input type="text" id="username" name="username" autocomplete="off" required>
      </div>
      <div class="input-group">
        <label for="password">Pass</label>
        <input type="password" id="password" name="password" autocomplete="off" required>
      </div>
      <button type="submit" class="btn" id="loginBtn">Login</button>

      <!-- Added link to survey -->
      <div class="survey-link">
        <a href="survey.html">➤ Go to Survey</a>
      </div>
      <!-- End added link -->

      <div id="errorMsg" class="error" role="alert">Invalid login. Try again.</div>
      <div id="lockoutMsg" class="lockout" role="status"></div>
    </form>
  </div>

  <!-- Splash overlay -->
  <div id="splash" class="splash" aria-hidden="true">
    <h1>Welcome to the New GMF Steel Site Plan Interaction Tool</h1>
    <p>Initializing…</p>
  </div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxlIWul_NZrwMLdJOMACFe2EzBaz993sFVEAuOJLS4vrfQ7Eebv9go8ZyPFg-dbgD1J/exec";
const loginForm = document.getElementById("loginForm");
const errorMsg  = document.getElementById("errorMsg");
const lockoutMsg = document.getElementById("lockoutMsg");
const splash = document.getElementById("splash");
const loginBtn = document.getElementById("loginBtn");

let attempts = 0;
let locked = false;
let lockoutTimer = null;

function showError(text) {
  errorMsg.textContent = text || "Invalid login. Try again.";
  errorMsg.style.display = "block";
}

function hideError() {
  errorMsg.style.display = "none";
}

function startLockout(seconds = 30) {
  locked = true;
  let wait = seconds;
  hideError();
  lockoutMsg.style.display = "block";
  lockoutMsg.textContent = `Too many attempts. Try again in ${wait}s.`;
  lockoutTimer = setInterval(() => {
    wait--;
    lockoutMsg.textContent = `Too many attempts. Try again in ${wait}s.`;
    if (wait <= 0) {
      clearInterval(lockoutTimer);
      lockoutMsg.style.display = "none";
      attempts = 0;
      locked = false;
    }
  }, 1000);
}

async function doLogin(username, password) {
  if (!username || !password) {
    showError("Please enter both user and pass.");
    return { success: false };
  }

  loginBtn.disabled = true;
  loginBtn.textContent = "Checking…";

  try {
    const resp = await fetch(SCRIPT_URL, {
      method: "POST",
      mode: "cors",
      cache: "no-cache",
      headers: {
        "Content-Type": "application/json;charset=UTF-8"
      },
      body: JSON.stringify({ username, password })
    });

    const data = await resp.json();
    return data;
  } catch (err) {
    console.error("Login request failed", err);
    showError("Server unreachable. Check your Apps Script URL and network.");
    return { success: false };
  } finally {
    loginBtn.disabled = false;
    loginBtn.textContent = "Login";
  }
}

loginForm.addEventListener("submit", async function(e) {
  e.preventDefault();
  if (locked) return;

  hideError();
  const user = document.getElementById("username").value.trim();
  const pass = document.getElementById("password").value.trim();

  const result = await doLogin(user, pass);

  if (result && result.success) {
    localStorage.setItem("gmf_user", user);
    if (result.role) localStorage.setItem("gmf_role", result.role);

    splash.classList.add("show");
    splash.setAttribute("aria-hidden", "false");

    if (result.role) {
      const p = splash.querySelector("p");
      if (p) p.textContent = `Welcome ${user} — role: ${result.role}`;
    }

    setTimeout(() => {
      splash.style.transition = "opacity 600ms ease";
      splash.style.opacity = 0;
      setTimeout(() => { window.location.href = "index.html"; }, 650);
    }, 2600);

  } else {
    attempts++;
    showError();
    if (attempts >= 3) {
      startLockout(30);
    }
  }
});
</script>
</body>
</html>
